<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload and List Documents</title>
  <style>
    table {
      border-collapse: collapse;
      width: 80%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Upload Document</h2>

  <form id="uploadForm">
    <input type="file" id="fileInput" name="file" required />
    <button type="submit">Upload</button>
  </form>

  <p id="status"></p>

  <h3>Documents List</h3>
  <table id="documentsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>File Name</th>
        <th>Upload Date</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody>
      <!-- Document rows go here -->
    </tbody>
  </table>

  <script>
    const baseUrl = "http://localhost:8084";

    async function fetchDocuments() {
      try {
        const response = await fetch(`${baseUrl}/documents`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const documents = await response.json();
        populateTable(documents);
      } catch (error) {
        document.getElementById("status").textContent = `Error loading documents: ${error.message}`;
      }
    }

    function populateTable(documents) {
      const tbody = document.querySelector("#documentsTable tbody");
      tbody.innerHTML = ""; // Clear existing rows

      documents.forEach(doc => {
        const tr = document.createElement("tr");

        // ID cell
        const idTd = document.createElement("td");
        idTd.textContent = doc.fileId || "";
        tr.appendChild(idTd);

        // File Name cell (clickable download link)
        const nameTd = document.createElement("td");
        if (doc.downloadURL) {
          const link = document.createElement("a");
          link.href = doc.downloadURL;
          link.textContent = doc.fileName || "";
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          nameTd.appendChild(link);
        } else {
          nameTd.textContent = doc.fileName || "";
        }
        tr.appendChild(nameTd);

        // Upload Date cell (optional)
        const dateTd = document.createElement("td");
        dateTd.textContent = ""; // Add date here if available
        tr.appendChild(dateTd);

        // Download column left empty (since file name is link)
        const downloadTd = document.createElement("td");
        downloadTd.textContent = "";
        tr.appendChild(downloadTd);

        tbody.appendChild(tr);
      });
    }

    async function uploadDocument(file) {
      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch(`${baseUrl}/upload`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Upload failed: ${errorText}`);
        }

        document.getElementById("status").textContent = "Upload successful!";
        await fetchDocuments();  // Refresh document list after upload
      } catch (error) {
        document.getElementById("status").textContent = `Error uploading file: ${error.message}`;
      }
    }

    document.getElementById("uploadForm").addEventListener("submit", (event) => {
      event.preventDefault();
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length === 0) {
        alert("Please select a file first.");
        return;
      }
      document.getElementById("status").textContent = "Uploading...";
      uploadDocument(fileInput.files[0]);
      fileInput.value = ""; // reset file input after submission
    });

    // Initial load
    fetchDocuments();
  </script>
</body>
</html>
